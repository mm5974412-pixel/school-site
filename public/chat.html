<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>NovaChat ‚Äî —á–∞—Ç</title>
  <link rel="stylesheet" href="/style.css" />
</head>
<body>
  <div class="app">
    <aside class="sidebar">
      <div class="sidebar-header">
        <div class="logo-left">
          <div class="logo-circle">N</div>
          <div class="logo-text">
            <div class="logo-name">NovaChat</div>
            <div class="logo-subtitle">–æ–Ω–ª–∞–π–Ω-–º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä</div>
          </div>
        </div>

        <button id="theme-toggle" class="theme-toggle" title="–°–º–µ–Ω–∏—Ç—å —Ç–µ–º—É">
          üåô
        </button>
      </div>

      <div class="current-user">
        <span class="current-user-label">–í—ã:</span>
        <span class="current-user-name" id="current-username">...</span>
      </div>

      <div class="sidebar-section-title">–ß–∞—Ç—ã</div>

      <button id="new-chat-btn" class="btn-secondary" style="width:100%; margin: 6px 0 10px;">
        ‚ûï –°–æ–∑–¥–∞—Ç—å —á–∞—Ç
      </button>

      <ul class="chat-list" id="chat-list">
        <!-- —á–∞—Ç—ã –±—É–¥—É—Ç –ø–æ–¥—Å—Ç–∞–≤–ª–µ–Ω—ã —Å–∫—Ä–∏–ø—Ç–æ–º -->
      </ul>

      <div class="sidebar-footer">
        <form action="/logout" method="POST">
          <button type="submit" class="btn-secondary">–í—ã–π—Ç–∏</button>
        </form>
        <form
          action="/delete-account"
          method="POST"
          onsubmit="return confirm('–¢–æ—á–Ω–æ —É–¥–∞–ª–∏—Ç—å –∞–∫–∫–∞—É–Ω—Ç? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ.');"
        >
          <button type="submit" class="btn-ghost">–£–¥–∞–ª–∏—Ç—å –∞–∫–∫–∞—É–Ω—Ç</button>
        </form>
      </div>
    </aside>

    <main class="chat-main">
      <div class="chat-main-header">
        <div class="chat-main-title" id="chat-title">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ NovaChat</div>
        <div class="chat-main-subtitle" id="chat-subtitle">
          –°–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—ã–π —á–∞—Ç, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –ø–µ—Ä–µ–ø–∏—Å–∫—É.
        </div>
      </div>

      <section id="messages" class="chat-main-messages"></section>

      <form id="chat-form" class="chat-main-input">
        <input
          id="message-input"
          type="text"
          placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..."
          autocomplete="off"
        />
        <button type="submit" class="btn-primary">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
      </form>
    </main>
  </div>

  <footer class="footer">
    <p>&copy; 2026 NovaChat</p>
  </footer>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const currentUsernameSpan = document.getElementById("current-username");
    const chatList = document.getElementById("chat-list");
    const newChatBtn = document.getElementById("new-chat-btn");
    const logoHeader = document.querySelector(".sidebar-header");
    const themeToggle = document.getElementById("theme-toggle");

    const messagesDiv = document.getElementById("messages");
    const form = document.getElementById("chat-form");
    const input = document.getElementById("message-input");
    const chatTitleEl = document.getElementById("chat-title");
    const chatSubtitleEl = document.getElementById("chat-subtitle");

    const socket = io();

    let currentUser = null;
    let currentChatId = null;

    // –ö–ª–∏–∫ –ø–æ "NovaChat" –≤ —Å–∞–π–¥–±–∞—Ä–µ ‚Äî –ø–µ—Ä–µ—Ö–æ–¥ –Ω–∞ –≥–ª–∞–≤–Ω—É—é
    if (logoHeader) {
      logoHeader.style.cursor = "pointer";
      logoHeader.addEventListener("click", () => {
        window.location.href = "/";
      });
    }

    // –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å —Ç–µ–º—ã (–ø–æ–∫–∞ –ø—Ä–æ—Å—Ç–∞—è –∑–∞–≥–ª—É—à–∫–∞)
    if (themeToggle) {
      themeToggle.addEventListener("click", () => {
        document.body.classList.toggle("light");
      });
    }

    // –£–∑–Ω–∞—ë–º, –∫—Ç–æ –≤–æ—à—ë–ª
    function loadCurrentUser() {
      return fetch("/me")
        .then((res) => {
          if (res.status === 401) {
            window.location.href = "/login.html";
            return null;
          }
          return res.json();
        })
        .then((data) => {
          if (!data) return;
          currentUser = data.username;
          if (currentUsernameSpan) {
            currentUsernameSpan.textContent = currentUser;
          }
        })
        .catch(() => {
          window.location.href = "/login.html";
        });
    }

    // –†–∏—Å—É–µ–º –æ–¥–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ
    function appendMessage(msg) {
      if (!messagesDiv) return;

      const el = document.createElement("div");
      el.classList.add("message");
      if (msg.id) {
        el.dataset.messageId = msg.id;
      }

      const isMe = msg.author === currentUser;
      if (isMe) {
        el.classList.add("me");
      }

      const authorEl = document.createElement("strong");
      authorEl.textContent = msg.author || "–ê–Ω–æ–Ω–∏–º";

      const textEl = document.createElement("span");
      textEl.textContent = msg.text;

      const timeEl = document.createElement("span");
      timeEl.classList.add("message-time");
      timeEl.textContent = msg.time || "";

      const metaEl = document.createElement("div");
      metaEl.classList.add("message-meta");
      metaEl.appendChild(timeEl);

      if (isMe && msg.id) {
        const deleteBtn = document.createElement("button");
        deleteBtn.type = "button";
        deleteBtn.classList.add("message-delete");
        deleteBtn.textContent = "–£–¥–∞–ª–∏—Ç—å";
        deleteBtn.title = "–£–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ";

        deleteBtn.addEventListener("click", () => {
          if (!currentChatId) return;
          const confirmed = confirm("–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ?");
          if (!confirmed) return;

          fetch(`/chats/${currentChatId}/messages/${msg.id}`, {
            method: "DELETE",
          })
            .then((res) => res.json())
            .then((data) => {
              if (!data.ok) {
                throw new Error(data.error || "–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ");
              }
              if (el.parentNode) {
                el.parentNode.removeChild(el);
              }
              if (messagesDiv && messagesDiv.children.length === 0) {
                showEmptyState("no-messages");
              }
            })
            .catch((err) => {
              console.error(err);
              alert("–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ");
            });
        });

        metaEl.appendChild(deleteBtn);
      }

      el.appendChild(authorEl);
      el.appendChild(textEl);
      el.appendChild(metaEl);

      messagesDiv.appendChild(el);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    // –ü—É—Å—Ç—ã–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è (–Ω–µ—Ç —á–∞—Ç–æ–≤, –Ω–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π –∏ —Ç.–ø.)
    function showEmptyState(mode) {
      if (!messagesDiv) return;

      messagesDiv.innerHTML = "";

      const empty = document.createElement("div");
      empty.classList.add("empty-state");

      const h2 = document.createElement("h2");
      const p = document.createElement("p");

      if (mode === "no-chats") {
        h2.textContent = "–°–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—ã–π —á–∞—Ç";
        p.textContent = "–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–ª–∏ –Ω–∞—á–Ω–∏—Ç–µ –Ω–æ–≤—ã–π –¥–∏–∞–ª–æ–≥.";
      } else if (mode === "select-chat") {
        h2.textContent = "–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç";
        p.textContent = "–°–ª–µ–≤–∞ –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –≤–∞—à–∏ –ª–∏—á–Ω—ã–µ —á–∞—Ç—ã.";
      } else if (mode === "no-messages") {
        h2.textContent = "–í —ç—Ç–æ–º —á–∞—Ç–µ –ø–æ–∫–∞ –Ω–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π";
        p.textContent = "–ù–∞–ø–∏—à–∏—Ç–µ –ø–µ—Ä–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –¥–∏–∞–ª–æ–≥.";
      }

      empty.appendChild(h2);
      empty.appendChild(p);
      messagesDiv.appendChild(empty);
    }

    // –†–∏—Å—É–µ–º —Å–ø–∏—Å–æ–∫ —Å–æ–æ–±—â–µ–Ω–∏–π
    function renderMessages(messages) {
      if (!messagesDiv) return;

      messagesDiv.innerHTML = "";

      if (!messages || messages.length === 0) {
        showEmptyState("no-messages");
        return;
      }

      messages.forEach(appendMessage);
    }

    // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —á–∞—Ç–∞
    function loadMessages(chatId) {
      if (!chatId) return;

      fetch(`/chats/${chatId}/messages`)
        .then((res) => {
          if (!res.ok) throw new Error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π");
          return res.json();
        })
        .then((data) => {
          if (!data.ok) throw new Error(data.error || "–û—à–∏–±–∫–∞");
          renderMessages(data.messages);
        })
        .catch((err) => {
          console.error(err);
        });
    }

    // –†–∏—Å—É–µ–º —Å–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤
    function renderChats(chats) {
      if (!chatList) return;

      chatList.innerHTML = "";

      // –ù–µ—Ç –Ω–∏ –æ–¥–Ω–æ–≥–æ —á–∞—Ç–∞
      if (!chats || chats.length === 0) {
        const li = document.createElement("li");
        li.style.fontSize = "12px";
        li.style.color = "#6b7280";
        li.style.padding = "4px 2px";
        li.textContent = "–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç —á–∞—Ç–æ–≤.";
        chatList.appendChild(li);

        if (chatTitleEl) chatTitleEl.textContent = "–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ NovaChat";
        if (chatSubtitleEl)
          chatSubtitleEl.textContent = "–°–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—ã–π —á–∞—Ç, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –ø–µ—Ä–µ–ø–∏—Å–∫—É.";

        currentChatId = null;
        showEmptyState("no-chats");
        return;
      }

      // –ï—Å—Ç—å —á–∞—Ç—ã, –Ω–æ –µ—â—ë –Ω–∏ –æ–¥–∏–Ω –Ω–µ –≤—ã–±—Ä–∞–Ω
      if (!currentChatId) {
        if (chatTitleEl) chatTitleEl.textContent = "NovaChat";
        if (chatSubtitleEl)
          chatSubtitleEl.textContent = "–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç —Å–ª–µ–≤–∞, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –ø–µ—Ä–µ–ø–∏—Å–∫—É.";
        showEmptyState("select-chat");
      }

      chats.forEach((chat) => {
        const li = document.createElement("li");
        li.classList.add("chat-item");
        li.dataset.chatId = chat.id;

        const avatar = document.createElement("div");
        avatar.classList.add("chat-avatar");
        avatar.textContent = chat.peer_username
          ? chat.peer_username[0].toUpperCase()
          : "?";

        const meta = document.createElement("div");
        meta.classList.add("chat-meta");

        const name = document.createElement("div");
        name.classList.add("chat-name");
        name.textContent = chat.peer_username;

        const last = document.createElement("div");
        last.classList.add("chat-last");
        last.textContent = "–õ–∏—á–Ω—ã–π —á–∞—Ç";

        meta.appendChild(name);
        meta.appendChild(last);
        li.appendChild(avatar);
        li.appendChild(meta);

        // –ü–æ–¥—Å–≤–µ—Ç–∏—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–π, –µ—Å–ª–∏ –æ–Ω –≤—ã–±—Ä–∞–Ω
        if (currentChatId && chat.id === currentChatId) {
          li.classList.add("chat-item-active");
        }

        li.addEventListener("click", () => {
          const prevChatId = currentChatId;

          // –æ—Ç–ø–∏—Å—ã–≤–∞–µ–º—Å—è –æ—Ç –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ —á–∞—Ç–∞
          if (prevChatId) {
            socket.emit("leave-chat", prevChatId);
          }

          currentChatId = chat.id;

          // –ø–æ–¥–ø–∏—Å—ã–≤–∞–µ–º—Å—è –Ω–∞ –Ω–æ–≤—ã–π —á–∞—Ç
          socket.emit("join-chat", chat.id);

          if (chatTitleEl) chatTitleEl.textContent = chat.peer_username;
          if (chatSubtitleEl)
            chatSubtitleEl.textContent = "–õ–∏—á–Ω—ã–π —á–∞—Ç. –°–æ–æ–±—â–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è.";

          document
            .querySelectorAll(".chat-item")
            .forEach((el) => el.classList.remove("chat-item-active"));
          li.classList.add("chat-item-active");

          loadMessages(chat.id);
        });

        chatList.appendChild(li);
      });
    }

    // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤
    function loadChats() {
      fetch("/chats/list")
        .then((res) => {
          if (!res.ok) throw new Error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —á–∞—Ç–æ–≤");
          return res.json();
        })
        .then((data) => {
          if (!data.ok) throw new Error(data.error || "–û—à–∏–±–∫–∞");
          renderChats(data.chats);
        })
        .catch((err) => {
          console.error(err);
        });
    }

    // –ö–Ω–æ–ø–∫–∞ "–°–æ–∑–¥–∞—Ç—å —á–∞—Ç"
    if (newChatBtn) {
      newChatBtn.addEventListener("click", () => {
        const username = prompt(
          "–í–≤–µ–¥–∏—Ç–µ –ª–æ–≥–∏–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, —Å –∫–æ—Ç–æ—Ä—ã–º —Ö–æ—Ç–∏—Ç–µ —á–∞—Ç:"
        );
        if (!username) return;

        fetch("/chats/new", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ username: username.trim() }),
        })
          .then((res) => res.json())
          .then((data) => {
            if (!data.ok) {
              alert(data.error || "–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å —á–∞—Ç");
              return;
            }

            if (data.existing) {
              alert(
                `–ß–∞—Ç —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º ${data.peerUsername} —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç. –ü–µ—Ä–µ–∫–ª—é—á–∞—é—Å—å –Ω–∞ –Ω–µ–≥–æ.`
              );
            } else {
              alert(`–°–æ–∑–¥–∞–Ω –Ω–æ–≤—ã–π —á–∞—Ç —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º ${data.peerUsername}.`);
            }

            loadChats();
          })
          .catch(() => {
            alert("–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —á–∞—Ç–∞");
          });
      });
    }

    // –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
    if (form && input) {
      form.addEventListener("submit", (e) => {
        e.preventDefault();
        const text = input.value.trim();
        if (!text) return;

        if (!currentChatId) {
          alert("–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç —Å–ª–µ–≤–∞ –∏–ª–∏ —Å–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—ã–π.");
          return;
        }

        fetch(`/chats/${currentChatId}/messages`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ text }),
        })
          .then((res) => {
            if (!res.ok) {
              throw new Error("–û—à–∏–±–∫–∞ –æ—Ç–≤–µ—Ç–∞ —Å–µ—Ä–≤–µ—Ä–∞");
            }
            // –æ—Ç–≤–µ—Ç –Ω–∞–º –Ω–µ –Ω—É–∂–µ–Ω, —Å–æ–æ–±—â–µ–Ω–∏–µ –ø—Ä–∏–¥—ë—Ç –ø–æ —Å–æ–∫–µ—Ç—É
            input.value = "";
          })
          .catch(() => {
            alert("–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Å–æ–æ–±—â–µ–Ω–∏—è");
          });
      });
    }

    // –°–ª—É—à–∞–µ–º –Ω–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ —Å–æ–∫–µ—Ç—É
    socket.on("chat:new-message", (msg) => {
      // –ï—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç –¥—Ä—É–≥–æ–π —á–∞—Ç ‚Äî –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º
      if (!currentChatId || msg.chatId !== currentChatId) return;

      // –µ—Å–ª–∏ –Ω–∞ —ç–∫—Ä–∞–Ω–µ –±—ã–ª –ø—É—Å—Ç–æ–π —Å—Ç–µ–π—Ç ‚Äî —É–±–∏—Ä–∞–µ–º
      if (messagesDiv && messagesDiv.querySelector(".empty-state")) {
        messagesDiv.innerHTML = "";
      }

      appendMessage(msg);
    });

    socket.on("chat:delete-message", (payload) => {
      if (!payload || !currentChatId || payload.chatId !== currentChatId) return;

      const messageEl = messagesDiv.querySelector(
        `[data-message-id="${payload.messageId}"]`
      );
      if (messageEl) {
        messageEl.remove();
      }

      if (messagesDiv && messagesDiv.children.length === 0) {
        showEmptyState("no-messages");
      }
    });

    // –°—Ç–∞—Ä—Ç: —É–∑–Ω–∞—ë–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –ø–æ–¥–≥—Ä—É–∂–∞–µ–º —á–∞—Ç—ã
    loadCurrentUser().then(() => {
      loadChats();
      // –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ —á–∞—Ç–æ–≤
      setInterval(loadChats, 5000);
      window.addEventListener("focus", loadChats);
    });
  </script>
</body>
</html>
