<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>NovaChat ‚Äî —á–∞—Ç</title>
  <link rel="stylesheet" href="/style.css" />
</head>
<body>
  <div class="app">
    <aside class="sidebar">
      <div class="sidebar-header">
        <div class="logo-left">
          <div class="logo-circle">N</div>
          <div class="logo-text">
            <div class="logo-name">NovaChat</div>
            <div class="logo-subtitle">–æ–Ω–ª–∞–π–Ω-–º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä</div>
          </div>
        </div>

        <button id="theme-toggle" class="theme-toggle" title="–°–º–µ–Ω–∏—Ç—å —Ç–µ–º—É">
          üåô
        </button>
      </div>

      <div class="current-user">
        <span class="current-user-label">–í—ã:</span>
        <span class="current-user-name" id="current-username">...</span>
      </div>

      <div class="sidebar-section-title">–ß–∞—Ç—ã</div>

      <button id="new-chat-btn" class="btn-secondary" style="width:100%; margin: 6px 0 10px;">
        ‚ûï –°–æ–∑–¥–∞—Ç—å —á–∞—Ç
      </button>

      <ul class="chat-list" id="chat-list">
        <!-- –ü–æ–∫–∞ –Ω–µ—Ç —á–∞—Ç–æ–≤, —Å–ø–∏—Å–æ–∫ –ø—É—Å—Ç–æ–π -->
      </ul>

      <div class="sidebar-footer">
        <form action="/logout" method="POST">
          <button type="submit" class="btn-secondary">–í—ã–π—Ç–∏</button>
        </form>
        <form
          action="/delete-account"
          method="POST"
          onsubmit="return confirm('–¢–æ—á–Ω–æ —É–¥–∞–ª–∏—Ç—å –∞–∫–∫–∞—É–Ω—Ç? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ.');"
        >
          <button type="submit" class="btn-ghost">–£–¥–∞–ª–∏—Ç—å –∞–∫–∫–∞—É–Ω—Ç</button>
        </form>
      </div>
    </aside>

    <main class="chat-main">
      <div class="chat-main-header">
        <div class="chat-main-title" id="chat-title">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ NovaChat</div>
        <div class="chat-main-subtitle" id="chat-subtitle">
          –°–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—ã–π —á–∞—Ç, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –ø–µ—Ä–µ–ø–∏—Å–∫—É.
        </div>
      </div>

      <section id="messages" class="chat-main-messages"></section>

      <form id="chat-form" class="chat-main-input">
        <input
          id="message-input"
          type="text"
          placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..."
          autocomplete="off"
        />
        <button type="submit" class="btn-primary">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
      </form>
    </main>
  </div>

  <footer class="footer">
    <p>&copy; 2026 NovaChat</p>
  </footer>

  <!-- socket.io –º–æ–∂–Ω–æ –æ—Å—Ç–∞–≤–∏—Ç—å, –Ω–æ –º—ã –µ–≥–æ –ø–æ–∫–∞ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ–º -->
  <script src="/socket.io/socket.io.js"></script>

  <script>
    const currentUsernameSpan = document.getElementById("current-username");
    const chatList = document.getElementById("chat-list");
    const newChatBtn = document.getElementById("new-chat-btn");
    const logoHeader = document.querySelector(".sidebar-header");
    const themeToggle = document.getElementById("theme-toggle");

    const messagesDiv = document.getElementById("messages");
    const form = document.getElementById("chat-form");
    const input = document.getElementById("message-input");
    const chatTitleEl = document.getElementById("chat-title");
    const chatSubtitleEl = document.getElementById("chat-subtitle");

    let currentUser = null;
    let currentChatId = null;

    // –ö–ª–∏–∫ –ø–æ "NovaChat" –≤ —Å–∞–π–¥–±–∞—Ä–µ ‚Äî –ø–µ—Ä–µ—Ö–æ–¥ –Ω–∞ –≥–ª–∞–≤–Ω—É—é
    if (logoHeader) {
      logoHeader.style.cursor = "pointer";
      logoHeader.addEventListener("click", () => {
        window.location.href = "/";
      });
    }

    // –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å —Ç–µ–º—ã (–ø—Ä–æ—Å—Ç–∞—è –∑–∞–≥–ª—É—à–∫–∞)
    if (themeToggle) {
      themeToggle.addEventListener("click", () => {
        document.body.classList.toggle("light");
      });
    }

    // –£–∑–Ω–∞—ë–º, –∫—Ç–æ –≤–æ—à—ë–ª
    function loadCurrentUser() {
      return fetch("/me")
        .then((res) => {
          if (res.status === 401) {
            window.location.href = "/login.html";
            return null;
          }
          return res.json();
        })
        .then((data) => {
          if (!data) return;
          currentUser = data.username;
          if (currentUsernameSpan) {
            currentUsernameSpan.textContent = currentUser;
          }
        })
        .catch(() => {
          window.location.href = "/login.html";
        });
    }

    // –†–ò–°–£–ï–ú –û–î–ù–û –°–û–û–ë–©–ï–ù–ò–ï
    function appendMessage(msg) {
      if (!messagesDiv) return;

      const el = document.createElement("div");
      el.classList.add("message");

      const isMe = msg.author === currentUser;
      if (isMe) {
        el.classList.add("me");
      }

      const authorEl = document.createElement("strong");
      authorEl.textContent = msg.author || "–ê–Ω–æ–Ω–∏–º";

      const textEl = document.createElement("span");
      textEl.textContent = msg.text;

      const timeEl = document.createElement("span");
      timeEl.classList.add("message-time");
      timeEl.textContent = msg.time || "";

      el.appendChild(authorEl);
      el.appendChild(textEl);
      el.appendChild(timeEl);

      messagesDiv.appendChild(el);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    // –ü–û–ö–ê–ó–ê–¢–¨ "–ü–£–°–¢–û–ô" –≠–ö–†–ê–ù
    function showEmptyState(mode) {
      if (!messagesDiv) return;

      messagesDiv.innerHTML = "";

      const empty = document.createElement("div");
      empty.classList.add("empty-state");

      const h2 = document.createElement("h2");
      const p = document.createElement("p");

      if (mode === "no-chats") {
        h2.textContent = "–°–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—ã–π —á–∞—Ç";
        p.textContent = "–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–ª–∏ –Ω–∞—á–Ω–∏—Ç–µ –Ω–æ–≤—ã–π –¥–∏–∞–ª–æ–≥.";
      } else if (mode === "select-chat") {
        h2.textContent = "–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç";
        p.textContent = "–°–ª–µ–≤–∞ –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –≤–∞—à–∏ –ª–∏—á–Ω—ã–µ —á–∞—Ç—ã.";
      } else if (mode === "no-messages") {
        h2.textContent = "–í —ç—Ç–æ–º —á–∞—Ç–µ –ø–æ–∫–∞ –Ω–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π";
        p.textContent = "–ù–∞–ø–∏—à–∏—Ç–µ –ø–µ—Ä–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –¥–∏–∞–ª–æ–≥.";
      }

      empty.appendChild(h2);
      empty.appendChild(p);
      messagesDiv.appendChild(empty);
    }

    // –†–ò–°–£–ï–ú –°–ü–ò–°–û–ö –°–û–û–ë–©–ï–ù–ò–ô
    function renderMessages(messages) {
      if (!messagesDiv) return;

      messagesDiv.innerHTML = "";

      if (!messages || messages.length === 0) {
        // –ü—É—Å—Ç–æ–π —á–∞—Ç ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â—É—é –Ω–∞–¥–ø–∏—Å—å
        showEmptyState("no-messages");
        return;
      }

      messages.forEach(appendMessage);
    }

    // –ó–ê–ì–†–£–ó–ö–ê –°–û–û–ë–©–ï–ù–ò–ô –î–õ–Ø –í–´–ë–†–ê–ù–ù–û–ì–û –ß–ê–¢–ê
    function loadMessages(chatId) {
      if (!chatId) return;

      fetch(`/chats/${chatId}/messages`)
        .then((res) => {
          if (!res.ok) throw new Error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π");
          return res.json();
        })
        .then((data) => {
          if (!data.ok) throw new Error(data.error || "–û—à–∏–±–∫–∞");
          renderMessages(data.messages);
        })
        .catch((err) => {
          console.error(err);
        });
    }

    // –†–ò–°–£–ï–ú –°–ü–ò–°–û–ö –ß–ê–¢–û–í –í –°–ê–ô–î–ë–ê–†–ï
    function renderChats(chats) {
      if (!chatList) return;

      chatList.innerHTML = "";

      // –ù–µ—Ç –Ω–∏ –æ–¥–Ω–æ–≥–æ —á–∞—Ç–∞
      if (!chats || chats.length === 0) {
        const li = document.createElement("li");
        li.style.fontSize = "12px";
        li.style.color = "#6b7280";
        li.style.padding = "4px 2px";
        li.textContent = "–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç —á–∞—Ç–æ–≤.";
        chatList.appendChild(li);

        // –®–∞–ø–∫–∞ –∏ —Ç–µ–∫—Å—Ç –≤ —Ü–µ–Ω—Ç—Ä–µ –¥–ª—è –ø—É—Å—Ç–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è
        if (chatTitleEl) chatTitleEl.textContent = "–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ NovaChat";
        if (chatSubtitleEl)
          chatSubtitleEl.textContent = "–°–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—ã–π —á–∞—Ç, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –ø–µ—Ä–µ–ø–∏—Å–∫—É.";

        showEmptyState("no-chats");

        return;
      }

      // –ï—Å—Ç—å —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω —á–∞—Ç, –Ω–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –µ—â—ë –Ω–µ –≤—ã–±—Ä–∞–Ω
      if (chatTitleEl) chatTitleEl.textContent = "NovaChat";
      if (chatSubtitleEl)
        chatSubtitleEl.textContent = "–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç —Å–ª–µ–≤–∞, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –ø–µ—Ä–µ–ø–∏—Å–∫—É.";

      showEmptyState("select-chat");

      chats.forEach((chat) => {
        const li = document.createElement("li");
        li.classList.add("chat-item");
        li.dataset.chatId = chat.id;

        const avatar = document.createElement("div");
        avatar.classList.add("chat-avatar");
        avatar.textContent = chat.peer_username
          ? chat.peer_username[0].toUpperCase()
          : "?";

        const meta = document.createElement("div");
        meta.classList.add("chat-meta");

        const name = document.createElement("div");
        name.classList.add("chat-name");
        name.textContent = chat.peer_username;

        const last = document.createElement("div");
        last.classList.add("chat-last");
        last.textContent = "–õ–∏—á–Ω—ã–π —á–∞—Ç";

        meta.appendChild(name);
        meta.appendChild(last);
        li.appendChild(avatar);
        li.appendChild(meta);

        li.addEventListener("click", () => {
          currentChatId = chat.id;

          if (chatTitleEl) chatTitleEl.textContent = chat.peer_username;
          if (chatSubtitleEl)
            chatSubtitleEl.textContent = "–õ–∏—á–Ω—ã–π —á–∞—Ç. –°–æ–æ–±—â–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è.";

          document
            .querySelectorAll(".chat-item")
            .forEach((el) => el.classList.remove("chat-item-active"));
          li.classList.add("chat-item-active");

          loadMessages(chat.id);
        });

        chatList.appendChild(li);
      });
    }

    // –ó–ê–ì–†–£–ñ–ê–ï–ú –°–ü–ò–°–û–ö –ß–ê–¢–û–í
    function loadChats() {
      fetch("/chats/list")
        .then((res) => {
          if (!res.ok) throw new Error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —á–∞—Ç–æ–≤");
          return res.json();
        })
        .then((data) => {
          if (!data.ok) throw new Error(data.error || "–û—à–∏–±–∫–∞");
          renderChats(data.chats);
        })
        .catch((err) => {
          console.error(err);
        });
    }

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ "–°–æ–∑–¥–∞—Ç—å —á–∞—Ç"
    if (newChatBtn) {
      newChatBtn.addEventListener("click", () => {
        const username = prompt(
          "–í–≤–µ–¥–∏—Ç–µ –ª–æ–≥–∏–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, —Å –∫–æ—Ç–æ—Ä—ã–º —Ö–æ—Ç–∏—Ç–µ —á–∞—Ç:"
        );
        if (!username) return;

        fetch("/chats/new", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ username: username.trim() }),
        })
          .then((res) => res.json())
          .then((data) => {
            if (!data.ok) {
              alert(data.error || "–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å —á–∞—Ç");
              return;
            }

            if (data.existing) {
              alert(
                `–ß–∞—Ç —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º ${data.peerUsername} —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç. –ü–µ—Ä–µ–∫–ª—é—á–∞—é—Å—å –Ω–∞ –Ω–µ–≥–æ.`
              );
            } else {
              alert(`–°–æ–∑–¥–∞–Ω –Ω–æ–≤—ã–π —á–∞—Ç —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º ${data.peerUsername}.`);
            }

            loadChats();
          })
          .catch(() => {
            alert("–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —á–∞—Ç–∞");
          });
      });
    }

    // –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –∏–∑ —Ñ–æ—Ä–º—ã
    if (form && input) {
      form.addEventListener("submit", (e) => {
        e.preventDefault();
        const text = input.value.trim();
        if (!text) return;

        if (!currentChatId) {
          alert("–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç —Å–ª–µ–≤–∞ –∏–ª–∏ —Å–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—ã–π.");
          return;
        }

        fetch(`/chats/${currentChatId}/messages`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ text }),
        })
          .then((res) => res.json())
          .then((data) => {
            if (!data.ok) {
              alert(data.error || "–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ");
              return;
            }

            // –ü–µ—Ä–µ–¥ –ø–µ—Ä–≤—ã–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º —É–±–∏—Ä–∞–µ–º –Ω–∞–¥–ø–∏—Å—å "–Ω–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π"
            messagesDiv.innerHTML = "";

            appendMessage(data.message);
            input.value = "";
          })
          .catch(() => {
            alert("–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Å–æ–æ–±—â–µ–Ω–∏—è");
          });
      });
    }

    // –°—Ç–∞—Ä—Ç: —É–∑–Ω–∞—ë–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –ø–æ—Ç–æ–º —á–∞—Ç—ã
    loadCurrentUser().then(() => {
      loadChats();
    });
  </script>
</body>
</html>
