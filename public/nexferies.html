<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Nexora ‚Äî –Ω–µ–∫—Å—Ñ–µ—Ä—ã</title>
  <link rel="stylesheet" href="/style-v2.css" />
  <script>
    (function() {
      const savedTheme = localStorage.getItem('theme');
      const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
      const shouldBeLight = savedTheme === 'light' || (!savedTheme && !prefersDark);
      if (shouldBeLight) {
        document.documentElement.classList.add('light');
      }
    })();
  </script>
  <script src="/theme-toggle.js" defer></script>
</head>
<body>
  <div class="app">
    <aside class="sidebar">
      <div class="sidebar-header">
        <div class="logo-circle">‚ú®</div>
        <div class="logo-text">
          <div class="logo-name">Nexora</div>
          <div class="logo-subtitle">–≥—Ä—É–ø–ø–æ–≤—ã–µ —á–∞—Ç—ã</div>
        </div>
      </div>

      <div class="current-user" id="profile-link" style="cursor: pointer;">
        <span class="current-user-label">–í—ã:</span>
        <span class="current-user-name" id="current-username">...</span>
      </div>

      <button id="theme-toggle" class="theme-toggle" style="width: 100%; margin-bottom: 10px;">üåô</button>

      <a
        href="/chat"
        class="btn-secondary"
        style="width: 100%; margin: 6px 0; text-align: center; text-decoration: none;"
      >
        üí¨ –ö —á–∞—Ç–∞–º
      </a>

      <a
        id="admin-panel-btn"
        href="/admin.html"
        class="btn-primary"
        style="width: 100%; margin: 6px 0; display: none; text-align: center; text-decoration: none;"
      >
        ‚öôÔ∏è –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å
      </a>

      <div class="sidebar-section-title">–ù–µ–∫—Å—Ñ–µ—Ä—ã</div>
      <div style="display: flex; gap: 6px; margin-bottom: 12px;">
        <button id="create-nexfery-btn" class="btn-secondary" style="flex: 1; padding: 8px;">
          ‚ûï –°–æ–∑–¥–∞—Ç—å
        </button>
        <button id="search-nexfery-btn" class="btn-secondary" style="flex: 1; padding: 8px;">
          üîç –ù–∞–π—Ç–∏
        </button>
      </div>

      <ul class="chat-list" id="nexferies-list"></ul>
    </aside>

    <main class="chat-main">
      <div class="chat-main-header">
        <div class="chat-main-top">
          <button id="back-to-nexferies" class="back-btn" type="button" style="display: none;">
            ‚Üê –ù–µ–∫—Å—Ñ–µ—Ä—ã
          </button>

          <div class="chat-main-titles">
            <div class="chat-main-title" id="nexfery-title" style="cursor: pointer;">
              ü´Ç –í—ã–±–µ—Ä–∏—Ç–µ –Ω–µ–∫—Å—Ñ–µ—Ä—É
            </div>
            <div class="chat-main-subtitle" id="nexfery-subtitle">
              –ù–∞–∂–º–∏—Ç–µ –Ω–∞ –Ω–µ–∫—Å—Ñ–µ—Ä—É —Å–ª–µ–≤–∞, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –ø–µ—Ä–µ–ø–∏—Å–∫—É, –∏–ª–∏ —Å–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—É—é.
            </div>
          </div>
        </div>
      </div>

      <section id="messages" class="chat-main-messages"></section>

      <form id="nexfery-form" class="chat-main-input" style="display: none;">
        <input id="nexfery-input" type="text" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." autocomplete="off"/>
        <button type="submit" class="btn-primary input-send-btn" id="nexfery-send-btn" title="–û—Ç–ø—Ä–∞–≤–∏—Ç—å">‚¨ÜÔ∏è</button>
      </form>
    </main>
  </div>

  <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å–æ–∑–¥–∞–Ω–∏—è –Ω–µ–∫—Å—Ñ–µ—Ä—ã -->
  <div id="create-nexfery-modal" class="nexus-modal" style="display: none;">
    <div class="nexus-modal-backdrop"></div>
    <div class="nexus-modal-content">
      <div class="nexus-modal-header">
        <h3>‚ú® –°–æ–∑–¥–∞—Ç—å –Ω–µ–∫—Å—Ñ–µ—Ä—É</h3>
        <button type="button" class="nexus-modal-close" id="create-nexfery-close">‚úï</button>
      </div>
      <form id="create-nexfery-form" class="nexus-form" enctype="multipart/form-data">
        <div class="nexus-form-row">
          <label>üìù –ù–∞–∑–≤–∞–Ω–∏–µ</label>
          <input type="text" name="title" id="nexfery-title-input" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä, –ù–∞—à –ø—Ä–æ–µ–∫—Ç" required />
        </div>
        <div class="nexus-form-row">
          <label>üîó –ù–∏–∫ (–ª–∞—Ç–∏–Ω–∏—Ü–∞)</label>
          <div class="nexus-handle-input">
            <span>@</span>
            <input type="text" name="handle" id="nexfery-handle-input" placeholder="nexfery_name" required />
          </div>
        </div>
        <div class="nexus-form-row">
          <label>üìã –û–ø–∏—Å–∞–Ω–∏–µ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
          <textarea name="description" id="nexfery-description-input" rows="3" placeholder="–û —á—ë–º —ç—Ç–∞ –Ω–µ–∫—Å—Ñ–µ—Ä–∞?"></textarea>
        </div>
        <div class="nexus-form-row">
          <label>üñºÔ∏è –ê–≤–∞—Ç–∞—Ä</label>
          <div class="nexus-file-input-wrapper">
            <input type="file" name="avatar" id="nexfery-avatar-input" accept="image/*" />
            <div class="nexus-file-label">
              <span class="nexus-file-icon">üì∑</span>
              <span class="nexus-file-text">–í—ã–±–µ—Ä–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</span>
            </div>
          </div>
        </div>
        <button type="submit" class="btn-primary" style="width: 100%; margin-top: 12px;">
          ‚ú® –°–æ–∑–¥–∞—Ç—å –Ω–µ–∫—Å—Ñ–µ—Ä—É
        </button>
      </form>
    </div>
  </div>

  <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ–∏—Å–∫–∞ –Ω–µ–∫—Å—Ñ–µ—Ä -->
  <div id="search-nexfery-modal" class="nexus-modal" style="display: none;">
    <div class="nexus-modal-backdrop"></div>
    <div class="nexus-modal-content">
      <div class="nexus-modal-header">
        <h3>üîç –ü–æ–∏—Å–∫ –Ω–µ–∫—Å—Ñ–µ—Ä</h3>
        <button type="button" class="nexus-modal-close" id="search-nexfery-close">‚úï</button>
      </div>
      <div class="nexus-modal-body">
        <input type="text" id="search-nexfery-input" placeholder="–ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é –∏–ª–∏ –Ω–∏–∫—É..." style="width: 100%; padding: 10px; border: 1px solid rgba(139, 92, 246, 0.3); border-radius: 8px; background: rgba(139, 92, 246, 0.05); color: inherit; margin-bottom: 12px;" />
        <div id="search-nexfery-results" style="max-height: 400px; overflow-y: auto;"></div>
      </div>
    </div>
  </div>

  <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –Ω–µ–∫—Å—Ñ–µ—Ä–µ -->
  <div id="nexfery-info-modal" class="nexus-modal" style="display: none;">
    <div class="nexus-modal-backdrop"></div>
    <div class="nexus-modal-content">
      <div class="nexus-modal-header">
        <button type="button" class="nexus-modal-close" id="nexfery-info-close">‚úï</button>
      </div>
      <div class="nexus-modal-body" id="nexfery-info-body"></div>
    </div>
  </div>

  <!-- Socket.IO –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ -->
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>

  <script>
    const socket = io();
    let currentNexferyId = null;
    let currentUserId = null;
    let currentUsername = null;

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    async function init() {
      try {
        const response = await fetch('/profile');
        if (!response.ok) {
          window.location.href = '/login.html';
          return;
        }

        const data = await response.json();
        currentUserId = data.user.id;
        currentUsername = data.user.display_name || data.user.username;

        document.getElementById('current-username').textContent = currentUsername;

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–¥–º–∏–Ω–∞
        if (data.user.is_admin) {
          document.getElementById('admin-panel-btn').style.display = 'block';
        }

        // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ –Ω–µ–∫—Å—Ñ–µ—Ä
        loadNexferies();

        // –ü–æ–¥–ø–∏—Å—ã–≤–∞–µ–º—Å—è –Ω–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
        socket.emit('user-online', currentUserId);
      } catch (err) {
        console.error('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏:', err);
        window.location.href = '/login.html';
      }
    }

    // –ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–ø–∏—Å–æ–∫ –Ω–µ–∫—Å—Ñ–µ—Ä
    async function loadNexferies() {
      try {
        const response = await fetch('/api/nexferies');
        if (!response.ok) throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏');

        const data = await response.json();
        const list = document.getElementById('nexferies-list');
        list.innerHTML = '';

        if (data.nexferies.length === 0) {
          list.innerHTML = '<li style="padding: 12px; text-align: center; color: rgba(255,255,255,0.5);">–ù–µ—Ç –Ω–µ–∫—Å—Ñ–µ—Ä</li>';
          return;
        }

        data.nexferies.forEach(nexfery => {
          const li = document.createElement('li');
          li.className = 'chat-item';
          li.innerHTML = `
            <div class="chat-item-content" onclick="selectNexfery(${nexfery.id})">
              <div class="chat-item-avatar" style="background: ${nexfery.avatarData ? '' : '#8b5cf6'};">
                ${nexfery.avatarData ? `<img src="${nexfery.avatarData}" style="width: 100%; height: 100%; object-fit: cover;" />` : 'ü´Ç'}
              </div>
              <div class="chat-item-info">
                <div class="chat-item-name">${escapeHtml(nexfery.title)}</div>
                <div class="chat-item-preview">@${escapeHtml(nexfery.handle)} ‚Ä¢ ${nexfery.membersCount} —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</div>
              </div>
            </div>
          `;
          list.appendChild(li);
        });
      } catch (err) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–µ–∫—Å—Ñ–µ—Ä:', err);
      }
    }

    // –í—ã–±—Ä–∞—Ç—å –Ω–µ–∫—Å—Ñ–µ—Ä—É
    async function selectNexfery(nexferyId) {
      currentNexferyId = nexferyId;

      try {
        // –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –Ω–µ–∫—Å—Ñ–µ—Ä–µ
        const infoResponse = await fetch(`/api/nexferies/${nexferyId}`);
        if (!infoResponse.ok) throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏');

        const infoData = await infoResponse.json();
        const nexfery = infoData.nexfery;

        // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫
        document.getElementById('nexfery-title').textContent = nexfery.title;
        document.getElementById('nexfery-subtitle').textContent = `@${nexfery.handle} ‚Ä¢ ${nexfery.membersCount} —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤`;

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π
        document.getElementById('nexfery-form').style.display = 'flex';

        // –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ –∫–æ–º–Ω–∞—Ç–µ —Å–æ–∫–µ—Ç–∞
        socket.emit('join-nexfery', nexferyId);

        // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è
        loadNexferyMessages(nexferyId);

        // –û–±–Ω–æ–≤–ª—è–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ –≤ —Å–ø–∏—Å–∫–µ
        document.querySelectorAll('.chat-item').forEach((item, i) => {
          item.classList.remove('active');
        });
        event.currentTarget.classList.add('active');
      } catch (err) {
        console.error('–û—à–∏–±–∫–∞ –≤—ã–±–æ—Ä–∞ –Ω–µ–∫—Å—Ñ–µ—Ä—ã:', err);
      }
    }

    // –ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è –Ω–µ–∫—Å—Ñ–µ—Ä—ã
    async function loadNexferyMessages(nexferyId) {
      try {
        const response = await fetch(`/api/nexferies/${nexferyId}/messages`);
        if (!response.ok) throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏');

        const data = await response.json();
        const messagesDiv = document.getElementById('messages');
        messagesDiv.innerHTML = '';

        data.messages.forEach(msg => {
          const messageEl = createMessageElement(msg);
          messagesDiv.appendChild(messageEl);
        });

        // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –≤–Ω–∏–∑
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
      } catch (err) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π:', err);
      }
    }

    // –°–æ–∑–¥–∞—Ç—å —ç–ª–µ–º–µ–Ω—Ç —Å–æ–æ–±—â–µ–Ω–∏—è
    function createMessageElement(msg) {
      const div = document.createElement('div');
      div.className = 'message';
      if (msg.authorId === currentUserId) {
        div.classList.add('message-own');
      }

      const time = new Date(msg.createdAt).toLocaleTimeString('ru-RU', {
        hour: '2-digit',
        minute: '2-digit'
      });

      div.innerHTML = `
        <div class="message-content">
          ${msg.authorId !== currentUserId ? `<div class="message-author">${escapeHtml(msg.author)}</div>` : ''}
          <div class="message-text">${escapeHtml(msg.text)}</div>
          <div class="message-time">${time}</div>
        </div>
      `;

      return div;
    }

    // –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ
    document.getElementById('nexfery-form').addEventListener('submit', async (e) => {
      e.preventDefault();

      if (!currentNexferyId) return;

      const input = document.getElementById('nexfery-input');
      const text = input.value.trim();

      if (!text) return;

      try {
        const response = await fetch(`/api/nexferies/${currentNexferyId}/messages`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ text })
        });

        if (!response.ok) throw new Error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏');

        input.value = '';
        input.focus();
      } catch (err) {
        console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è:', err);
      }
    });

    // –°–ª—É—à–∞–µ–º –Ω–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ —Å–æ–∫–µ—Ç—É
    socket.on('nexfery:new-message', (msg) => {
      if (msg.nexferyId === currentNexferyId) {
        const messagesDiv = document.getElementById('messages');
        const messageEl = createMessageElement(msg);
        messagesDiv.appendChild(messageEl);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
      }
    });

    // –°–ª—É—à–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –Ω–µ–∫—Å—Ñ–µ—Ä
    socket.on('nexferies:updated', () => {
      loadNexferies();
    });

    // –°–æ–∑–¥–∞–Ω–∏–µ –Ω–µ–∫—Å—Ñ–µ—Ä—ã
    document.getElementById('create-nexfery-btn').addEventListener('click', () => {
      document.getElementById('create-nexfery-modal').style.display = 'flex';
    });

    document.getElementById('create-nexfery-close').addEventListener('click', () => {
      document.getElementById('create-nexfery-modal').style.display = 'none';
    });

    document.getElementById('create-nexfery-form').addEventListener('submit', async (e) => {
      e.preventDefault();

      const formData = new FormData(e.target);

      try {
        const response = await fetch('/api/nexferies', {
          method: 'POST',
          body: formData
        });

        if (!response.ok) {
          const error = await response.json();
          alert('–û—à–∏–±–∫–∞: ' + error.error);
          return;
        }

        document.getElementById('create-nexfery-modal').style.display = 'none';
        e.target.reset();
        loadNexferies();
      } catch (err) {
        console.error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –Ω–µ–∫—Å—Ñ–µ—Ä—ã:', err);
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –Ω–µ–∫—Å—Ñ–µ—Ä—ã');
      }
    });

    // –ü–æ–∏—Å–∫ –Ω–µ–∫—Å—Ñ–µ—Ä
    document.getElementById('search-nexfery-btn').addEventListener('click', () => {
      document.getElementById('search-nexfery-modal').style.display = 'flex';
      document.getElementById('search-nexfery-input').focus();
    });

    document.getElementById('search-nexfery-close').addEventListener('click', () => {
      document.getElementById('search-nexfery-modal').style.display = 'none';
    });

    let searchTimeout;
    document.getElementById('search-nexfery-input').addEventListener('input', async (e) => {
      clearTimeout(searchTimeout);
      const query = e.target.value.trim();

      if (!query) {
        document.getElementById('search-nexfery-results').innerHTML = '';
        return;
      }

      searchTimeout = setTimeout(async () => {
        try {
          const response = await fetch(`/api/nexferies/search/all?q=${encodeURIComponent(query)}`);
          if (!response.ok) throw new Error('–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞');

          const data = await response.json();
          const resultsDiv = document.getElementById('search-nexfery-results');
          resultsDiv.innerHTML = '';

          if (data.nexferies.length === 0) {
            resultsDiv.innerHTML = '<p style="text-align: center; color: rgba(255,255,255,0.5);">–ù–µ –Ω–∞–π–¥–µ–Ω–æ</p>';
            return;
          }

          data.nexferies.forEach(nexfery => {
            const div = document.createElement('div');
            div.className = 'nexus-search-result';
            div.style.cssText = 'padding: 12px; border-bottom: 1px solid rgba(139, 92, 246, 0.1); cursor: pointer; border-radius: 8px; margin-bottom: 8px; background: rgba(139, 92, 246, 0.05);';
            div.innerHTML = `
              <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                  <div style="font-weight: 500;">${escapeHtml(nexfery.title)}</div>
                  <div style="font-size: 12px; color: rgba(255,255,255,0.5);">@${escapeHtml(nexfery.handle)} ‚Ä¢ ${nexfery.membersCount} —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</div>
                </div>
                <button class="btn-secondary" style="padding: 4px 12px; font-size: 12px;">–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è</button>
              </div>
            `;

            div.querySelector('button').addEventListener('click', async (ev) => {
              ev.preventDefault();
              ev.stopPropagation();

              try {
                const joinResponse = await fetch(`/api/nexferies/${nexfery.id}/join`, {
                  method: 'POST'
                });

                if (!joinResponse.ok) throw new Error('–û—à–∏–±–∫–∞ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è');

                document.getElementById('search-nexfery-modal').style.display = 'none';
                loadNexferies();
              } catch (err) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è:', err);
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–∏');
              }
            });

            resultsDiv.appendChild(div);
          });
        } catch (err) {
          console.error('–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞:', err);
        }
      }, 500);
    });

    // –ö–ª–∏–∫ –Ω–∞ –∑–∞–≥–æ–ª–æ–≤–æ–∫ –Ω–µ–∫—Å—Ñ–µ—Ä—ã - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ñ–æ
    document.getElementById('nexfery-title').addEventListener('click', async () => {
      if (!currentNexferyId) return;

      try {
        const membersResponse = await fetch(`/api/nexferies/${currentNexferyId}/members`);
        if (!membersResponse.ok) throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏');

        const membersData = await membersResponse.json();
        const infoResponse = await fetch(`/api/nexferies/${currentNexferyId}`);
        const infoData = await infoResponse.json();
        const nexfery = infoData.nexfery;

        const body = document.getElementById('nexfery-info-body');
        body.innerHTML = `
          <div style="text-align: center; margin-bottom: 20px;">
            <div class="profile-avatar" style="width: 80px; height: 80px; margin: 0 auto 12px; background: #8b5cf6;">
              ${nexfery.avatarData ? `<img src="${nexfery.avatarData}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 8px;" />` : 'ü´Ç'}
            </div>
            <h2 style="margin: 0 0 4px 0;">${escapeHtml(nexfery.title)}</h2>
            <p style="margin: 0; color: rgba(255,255,255,0.5);">@${escapeHtml(nexfery.handle)}</p>
          </div>

          ${nexfery.description ? `<p style="margin-bottom: 16px; padding: 12px; background: rgba(139, 92, 246, 0.05); border-radius: 8px;">${escapeHtml(nexfery.description)}</p>` : ''}

          <div style="margin-bottom: 16px;">
            <h4 style="margin: 0 0 8px 0; color: rgba(255,255,255,0.7);">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h4>
            <p style="margin: 4px 0; font-size: 14px;">üë• –£—á–∞—Å—Ç–Ω–∏–∫–æ–≤: ${nexfery.membersCount}</p>
          </div>

          <div style="margin-bottom: 16px;">
            <h4 style="margin: 0 0 8px 0; color: rgba(255,255,255,0.7);">üë• –£—á–∞—Å—Ç–Ω–∏–∫–∏</h4>
            <div style="max-height: 200px; overflow-y: auto;">
              ${membersData.members.map(member => `
                <div style="padding: 8px; margin-bottom: 4px; background: rgba(139, 92, 246, 0.05); border-radius: 6px; font-size: 14px;">
                  ${escapeHtml(member.displayName || member.username)}
                  ${member.role === 'owner' ? ' <span style="color: #fbbf24;">üëë</span>' : ''}
                </div>
              `).join('')}
            </div>
          </div>

          ${nexfery.userRole !== 'owner' ? `
            <button class="btn-ghost" style="width: 100%; padding: 8px;" id="leave-nexfery-btn">
              –í—ã–π—Ç–∏ –∏–∑ –Ω–µ–∫—Å—Ñ–µ—Ä—ã
            </button>
          ` : ''}
        `;

        if (nexfery.userRole !== 'owner') {
          body.querySelector('#leave-nexfery-btn').addEventListener('click', async () => {
            if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã?')) {
              try {
                const leaveResponse = await fetch(`/api/nexferies/${currentNexferyId}/leave`, {
                  method: 'POST'
                });

                if (!leaveResponse.ok) throw new Error('–û—à–∏–±–∫–∞ –≤—ã—Ö–æ–¥–∞');

                document.getElementById('nexfery-info-modal').style.display = 'none';
                currentNexferyId = null;
                document.getElementById('nexfery-form').style.display = 'none';
                document.getElementById('messages').innerHTML = '';
                document.getElementById('nexfery-title').textContent = 'ü´Ç –í—ã–±–µ—Ä–∏—Ç–µ –Ω–µ–∫—Å—Ñ–µ—Ä—É';
                document.getElementById('nexfery-subtitle').textContent = '–ù–∞–∂–º–∏—Ç–µ –Ω–∞ –Ω–µ–∫—Å—Ñ–µ—Ä—É —Å–ª–µ–≤–∞, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –ø–µ—Ä–µ–ø–∏—Å–∫—É, –∏–ª–∏ —Å–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—É—é.';
                loadNexferies();
              } catch (err) {
                console.error('–û—à–∏–±–∫–∞ –≤—ã—Ö–æ–¥–∞:', err);
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ');
              }
            }
          });
        }

        document.getElementById('nexfery-info-modal').style.display = 'flex';
      } catch (err) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–Ω—Ñ–æ:', err);
      }
    });

    document.getElementById('nexfery-info-close').addEventListener('click', () => {
      document.getElementById('nexfery-info-modal').style.display = 'none';
    });

    // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª–µ–π –ø—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ —Ñ–æ–Ω
    ['create-nexfery-modal', 'search-nexfery-modal', 'nexfery-info-modal'].forEach(modalId => {
      const modal = document.getElementById(modalId);
      if (modal) {
        modal.addEventListener('click', (e) => {
          if (e.target === modal) {
            modal.style.display = 'none';
          }
        });
      }
    });

    // –£—Ç–∏–ª–∏—Ç–∞ –¥–ª—è —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è HTML
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    init();
  </script>
</body>
</html>
