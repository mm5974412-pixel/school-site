<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Nexora ‚Äî –Ω–µ–∫—Å—É—Å—ã</title>
  <link rel="stylesheet" href="/style-v2.css" />
  <script>
    (function() {
      const savedTheme = localStorage.getItem('theme');
      const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
      const shouldBeLight = savedTheme === 'light' || (!savedTheme && !prefersDark);
      if (shouldBeLight) {
        document.documentElement.classList.add('light');
      }
    })();
  </script>
  <script src="/theme-toggle.js" defer></script>
</head>
<body>
  <div class="app">
    <aside class="sidebar">
      <div class="sidebar-header">
        <div class="logo-circle">‚ú®</div>
        <div class="logo-text">
          <div class="logo-name">Nexora</div>
          <div class="logo-subtitle">–Ω–µ–∫—Å—É—Å—ã –∏ —Å–æ–æ–±—â–µ—Å—Ç–≤–∞</div>
        </div>
      </div>

      <div class="current-user" id="profile-link" style="cursor: pointer;">
        <span class="current-user-label">–í—ã:</span>
        <span class="current-user-name" id="current-username">...</span>
      </div>

      <button id="theme-toggle" class="theme-toggle" style="width: 100%; margin-bottom: 10px;">üåô</button>

      <a
        href="/chat"
        class="btn-secondary"
        style="width: 100%; margin: 6px 0; text-align: center; text-decoration: none;"
      >
        üí¨ –ö —á–∞—Ç–∞–º
      </a>

      <a
        href="/nexferies.html"
        class="btn-secondary"
        style="width: 100%; margin: 6px 0; text-align: center; text-decoration: none;"
      >
        ü´Ç –ù–µ–∫—Å—Ñ–µ—Ä—ã
      </a>

      <a
        id="admin-panel-btn"
        href="/admin.html"
        class="btn-primary"
        style="width: 100%; margin: 6px 0; display: none; text-align: center; text-decoration: none;"
      >
        ‚öôÔ∏è –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å
      </a>
    </aside>

    <main class="chat-main">
      <div class="chat-main-header">
        <div class="chat-main-top">
          <div class="chat-main-titles">
            <div class="chat-main-title">üß≠ –ù–µ–∫—Å—É—Å—ã</div>
            <div class="chat-main-subtitle">–°–æ–∑–¥–∞–≤–∞–π—Ç–µ –Ω–µ–∫—Å—É—Å—ã, –ø–æ–¥–ø–∏—Å—ã–≤–∞–π—Ç–µ—Å—å –∏ —á–∏—Ç–∞–π—Ç–µ –ø–æ—Å—Ç—ã.</div>
          </div>
        </div>
      </div>

      <section class="nexus-section">
        <div id="create-nexus-buttons" class="create-nexus-buttons-container" style="display: flex; gap: 12px; justify-content: center; flex-wrap: wrap; margin: 20px 0;">
          <button id="show-nexus-form-btn" class="theme-toggle" style="flex: 0; padding: 10px 16px; border-radius: 10px; background: rgba(139, 92, 246, 0.05); border: 1px solid rgba(139, 92, 246, 0.3); color: #c7d2fe; font-size: 14px; font-weight: 500; cursor: pointer; display: inline-flex; align-items: center; justify-content: center;">‚ú® –°–æ–∑–¥–∞—Ç—å –Ω–µ–∫—Å—É—Å</button>
          <a href="/nexus-search.html" class="theme-toggle" style="flex: 0; padding: 10px 16px; border-radius: 10px; background: rgba(139, 92, 246, 0.05); border: 1px solid rgba(139, 92, 246, 0.3); color: #c7d2fe; font-size: 14px; font-weight: 500; display: inline-flex; align-items: center; justify-content: center; text-decoration: none;">üß≠ –ù–µ–∫—Å–∞—Ü–∏—è</a>
        </div>
        <div class="nexus-form-card" style="display: none;">
          <div class="nexus-form-header">
            <h3>‚ú® –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –Ω–µ–∫—Å—É—Å</h3>
            <p class="nexus-form-subtitle">–ù–∞—á–Ω–∏—Ç–µ —Å—Ç—Ä–æ–∏—Ç—å —Å–≤–æ–µ —Å–æ–æ–±—â–µ—Å—Ç–≤–æ –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å</p>
          </div>
          <form id="nexus-create-form" class="nexus-form" enctype="multipart/form-data">
            <div class="nexus-form-row">
              <label>üìù –ù–∞–∑–≤–∞–Ω–∏–µ</label>
              <input type="text" name="title" id="nexus-title" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä, –ù–æ–≤—ã–µ –∏–¥–µ–∏" required />
            </div>
            <div class="nexus-form-row">
              <label>üîó –ù–∏–∫ (–ª–∞—Ç–∏–Ω–∏—Ü–∞)</label>
              <div class="nexus-handle-input">
                <span>@</span>
                <input type="text" name="handle" id="nexus-handle" placeholder="nexus_ideas" required />
              </div>
            </div>
            <div class="nexus-form-row">
              <label>üìã –û–ø–∏—Å–∞–Ω–∏–µ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
              <textarea name="description" id="nexus-description" rows="3" placeholder="–û —á–µ–º —ç—Ç–æ—Ç –Ω–µ–∫—Å—É—Å?"></textarea>
            </div>
            <div class="nexus-form-row">
              <label>üñºÔ∏è –ê–≤–∞—Ç–∞—Ä</label>
              <div class="nexus-file-input-wrapper">
                <input type="file" name="avatar" id="nexus-avatar" accept="image/*" />
                <div class="nexus-file-label">
                  <span class="nexus-file-icon">üì∑</span>
                  <span class="nexus-file-text">–í—ã–±–µ—Ä–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</span>
                </div>
              </div>
              <div id="nexus-file-name" class="nexus-file-name"></div>
            </div>
            <div id="nexus-error" class="nexus-error"></div>
            <div class="nexus-form-actions">
              <button type="button" class="btn-secondary btn-cancel" id="nexus-cancel-btn">
                <span>‚úï –û—Ç–º–µ–Ω–∞</span>
              </button>
              <button type="submit" class="btn-create">
                <span>‚úì –°–æ–∑–¥–∞—Ç—å</span>
              </button>
            </div>
          </form>
        </div>

        <div class="nexus-list" id="nexus-list"></div>
      </section>
    </main>
  </div>

  <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è –Ω–µ–∫—Å—É—Å–∞ –Ω–∞ –º–æ–±–∏–ª—è—Ö -->
  <div id="nexus-modal" class="nexus-modal" style="display: none;">
    <div class="nexus-modal-backdrop"></div>
    <div class="nexus-modal-content">
      <div class="nexus-modal-header">
        <button class="nexus-modal-close" id="nexus-modal-close">‚úï</button>
      </div>
      <div class="nexus-modal-body" id="nexus-modal-body"></div>
    </div>
  </div>

  <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –ø—Ä–æ—Ñ–∏–ª—è –Ω–µ–∫—Å—É—Å–∞ -->
  <div id="nexus-profile-modal" class="nexus-modal" style="display: none;">
    <div class="nexus-modal-backdrop"></div>
    <div class="nexus-modal-content" style="max-width: 400px;">
      <div class="nexus-modal-header">
        <button class="nexus-modal-close" id="nexus-profile-modal-close">‚úï</button>
      </div>
      <div class="nexus-modal-body" id="nexus-profile-modal-body"></div>
    </div>
  </div>

  <script>
    const currentUsernameEl = document.getElementById('current-username');
    const adminPanelBtn = document.getElementById('admin-panel-btn');
    const nexusListEl = document.getElementById('nexus-list');
    const createForm = document.getElementById('nexus-create-form');
    const nexusErrorEl = document.getElementById('nexus-error');
    const nexusModal = document.getElementById('nexus-modal');
    const nexusModalBody = document.getElementById('nexus-modal-body');
    const nexusProfileModal = document.getElementById('nexus-profile-modal');
    const nexusProfileModalBody = document.getElementById('nexus-profile-modal-body');

    let currentUser = null;

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è –Ω–µ–∫—Å—É—Å–∞ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ
    async function openNexusModal(nexusId) {
      nexusModal.style.display = 'flex';
      document.body.style.overflow = 'hidden';

      try {
        const res = await fetch(`/api/nexus/${nexusId}`);
        const data = await res.json();
        if (!data.ok) {
          nexusModalBody.innerHTML = `<div class="nexus-error">${data.error || '–ù–µ–∫—Å—É—Å –Ω–µ –Ω–∞–π–¥–µ–Ω'}</div>`;
          return;
        }

        const nexus = data.nexus;
        const authorName = nexus.author_display_name || nexus.author_username;
        const isOwner = nexus.my_role === 'owner';
        
        const isMobile = window.innerWidth <= 768;
        let html = `
          <div class="nexus-modal-nexus-header">
            <div class="nexus-modal-avatar" style="${nexus.avatar_data ? `background-image: url(${nexus.avatar_data})` : ''}">${!nexus.avatar_data ? nexus.title.charAt(0).toUpperCase() : ''}</div>
            <div class="nexus-modal-info">
              <h2>${nexus.title}</h2>
              <p>@${nexus.handle}</p>
              <div class="nexus-modal-meta">–ê–≤—Ç–æ—Ä: ${authorName} ¬∑ –ü–æ–¥–ø–∏—Å—á–∏–∫–∏: ${nexus.subscribers_count} ¬∑ –ü–æ—Å—Ç—ã: ${nexus.posts_count}</div>
              <p class="nexus-modal-desc">${nexus.description || '–ë–µ–∑ –æ–ø–∏—Å–∞–Ω–∏—è'}</p>
            </div>
          </div>
        `;

        // –§–æ—Ä–º–∞ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø–æ—Å—Ç–∞ (—Ç–æ–ª—å–∫–æ –¥–ª—è –≤–ª–∞–¥–µ–ª—å—Ü–∞)
        if (isOwner) {
          html += `
            <div class="nexus-post-form">
              <h3>‚ú® –ù–æ–≤—ã–π –ø–æ—Å—Ç</h3>
              <textarea id="nexus-modal-post-text" rows="4" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ –ø–æ—Å—Ç..." class="nexus-modal-textarea"></textarea>
              <button id="nexus-modal-post-submit" class="btn-primary">üì§ –û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å</button>
              <div id="nexus-modal-post-error" class="nexus-error"></div>
            </div>
          `;
        }

        html += `<div class="nexus-modal-posts" id="nexus-modal-posts">–ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ—Å—Ç–æ–≤...</div>`;

        nexusModalBody.innerHTML = html;
        await loadNexusPostsInModal(nexusId);

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø–æ—Å—Ç–∞ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –≤–ª–∞–¥–µ–ª–µ—Ü)
        if (isOwner) {
          const submitBtn = document.getElementById('nexus-modal-post-submit');
          const textEl = document.getElementById('nexus-modal-post-text');
          const errorEl = document.getElementById('nexus-modal-post-error');

          submitBtn.addEventListener('click', async () => {
            errorEl.textContent = '';
            const text = textEl.value.trim();
            if (!text) {
              errorEl.textContent = '–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –ø–æ—Å—Ç–∞.';
              return;
            }

            submitBtn.disabled = true;
            try {
              const res = await fetch(`/api/nexus/${nexusId}/posts`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ text })
              });
              const data = await res.json();
              if (!data.ok) {
                errorEl.textContent = data.error || '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –ø–æ—Å—Ç';
              } else {
                textEl.value = '';
                await loadNexusPostsInModal(nexusId);
              }
            } catch (err) {
              errorEl.textContent = '–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ';
              console.error(err);
            } finally {
              submitBtn.disabled = false;
            }
          });
        }
      } catch (err) {
        console.error(err);
        nexusModalBody.innerHTML = '<div class="nexus-error">–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –Ω–µ–∫—Å—É—Å–∞</div>';
      }
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ—Å—Ç–æ–≤ –Ω–µ–∫—Å—É—Å–∞ –≤ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
    async function loadNexusPostsInModal(nexusId) {
      try {
        const res = await fetch(`/api/nexus/${nexusId}/posts`);
        const data = await res.json();
        if (!data.ok) {
          document.getElementById('nexus-modal-posts').innerHTML = '<div class="nexus-error">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –ø–æ—Å—Ç—ã</div>';
          return;
        }

        const postsContainer = document.getElementById('nexus-modal-posts');
        postsContainer.innerHTML = '';

        if (data.posts.length === 0) {
          postsContainer.innerHTML = '<div class="nexus-empty">–ü–æ—Å—Ç–æ–≤ –Ω–µ—Ç</div>';
          return;
        }

        data.posts.forEach((post) => {
          const postEl = document.createElement('div');
          postEl.className = 'nexus-modal-post';
          const authorName = post.author_display_name || post.author_username;
          postEl.innerHTML = `
            <div class="nexus-post-header">${authorName} ¬∑ ${new Date(post.created_at).toLocaleString('ru-RU')}</div>
            <div class="nexus-post-text">${post.text}</div>
            <div class="nexus-post-footer">üí¨ ${post.comments_count} –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤</div>
          `;
          postsContainer.appendChild(postEl);
        });
      } catch (err) {
        console.error(err);
        document.getElementById('nexus-modal-posts').innerHTML = '<div class="nexus-error">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ—Å—Ç–æ–≤</div>';
      }
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
    function closeNexusModal() {
      nexusModal.style.display = 'none';
      document.body.style.overflow = 'auto';
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è –ø—Ä–æ—Ñ–∏–ª—è –Ω–µ–∫—Å—É—Å–∞
    async function openNexusProfile(nexusId) {
      nexusProfileModal.style.display = 'flex';
      document.body.style.overflow = 'hidden';

      try {
        const res = await fetch(`/api/nexus/${nexusId}`);
        const data = await res.json();
        if (!data.ok) {
          nexusProfileModalBody.innerHTML = `<div class="nexus-error">${data.error || '–ù–µ–∫—Å—É—Å –Ω–µ –Ω–∞–π–¥–µ–Ω'}</div>`;
          return;
        }

        const nexus = data.nexus;
        const isOwner = nexus.my_role === 'owner';
        const isSubscribed = nexus.my_role === 'subscriber';

        let html = `
          <div class="nexus-channel-card">
            <div class="nexus-channel-header">
              <div class="nexus-channel-avatar" style="${nexus.avatar_data ? `background-image: url(${nexus.avatar_data})` : ''}">
                ${!nexus.avatar_data ? nexus.title.charAt(0).toUpperCase() : ''}
              </div>
              <div class="nexus-channel-title">${nexus.title}</div>
              <div class="nexus-channel-handle">@${nexus.handle}</div>
            </div>
            <div class="nexus-channel-meta">–ü–æ–¥–ø–∏—Å—á–∏–∫–∏: ${nexus.subscribers_count} ¬∑ –ü–æ—Å—Ç—ã: ${nexus.posts_count}</div>
            <div class="nexus-channel-about">
              <div class="nexus-channel-about-title">–û –∫–∞–Ω–∞–ª–µ</div>
              <div class="nexus-channel-about-text">${nexus.description || '–ë–µ–∑ –æ–ø–∏—Å–∞–Ω–∏—è'}</div>
            </div>
            <div class="nexus-channel-actions">
              <button id="nexus-report-btn" class="btn-secondary">‚ö†Ô∏è –ñ–∞–ª–æ–±–∞</button>
              ${!isOwner && isSubscribed ? `<button id="nexus-leave-btn" class="btn-secondary">üëã –ü–æ–∫–∏–Ω—É—Ç—å –Ω–µ–∫—Å—É—Å</button>` : ''}
            </div>
          </div>
        `;
        nexusProfileModalBody.innerHTML = html;

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∂–∞–ª–æ–±—ã
        const reportBtn = document.getElementById('nexus-report-btn');
        if (reportBtn) {
          reportBtn.addEventListener('click', () => {
            alert('–°–ø–∞—Å–∏–±–æ –∑–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ. –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –ø—Ä–æ–≤–µ—Ä–∏—Ç –∂–∞–ª–æ–±—É.');
            closeNexusProfile();
          });
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—ã—Ö–æ–¥–∞ –∏–∑ –Ω–µ–∫—Å—É—Å–∞
        const leaveBtn = document.getElementById('nexus-leave-btn');
        if (leaveBtn) {
          leaveBtn.addEventListener('click', async () => {
            if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –ø–æ–∫–∏–Ω—É—Ç—å —ç—Ç–æ—Ç –Ω–µ–∫—Å—É—Å?')) {
              try {
                const leaveRes = await fetch(`/api/nexus/${nexusId}/unsubscribe`, { method: 'POST' });
                const leaveData = await leaveRes.json();
                if (leaveData.ok) {
                  await loadNexus();
                  closeNexusProfile();
                } else {
                  alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ –∏–∑ –Ω–µ–∫—Å—É—Å–∞');
                }
              } catch (err) {
                console.error(err);
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ –∏–∑ –Ω–µ–∫—Å—É—Å–∞');
              }
            }
          });
        }
      } catch (err) {
        console.error(err);
        nexusProfileModalBody.innerHTML = '<div class="nexus-error">–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –ø—Ä–æ—Ñ–∏–ª—è</div>';
      }
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è –ø—Ä–æ—Ñ–∏–ª—è –Ω–µ–∫—Å—É—Å–∞
    function closeNexusProfile() {
      nexusProfileModal.style.display = 'none';
      document.body.style.overflow = 'auto';
    }

    // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø–æ –∫–ª–∏–∫—É –Ω–∞ –∫—Ä–µ—Å—Ç
    document.getElementById('nexus-modal-close').addEventListener('click', closeNexusModal);

    // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø–æ –∫–ª–∏–∫—É –Ω–∞ —Ñ–æ–Ω
    document.querySelector('.nexus-modal-backdrop').addEventListener('click', closeNexusModal);

    // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ –∫–ª–∏–∫—É –Ω–∞ —Ñ–æ–Ω –∏ ESC
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && nexusModal.style.display !== 'none') {
        closeNexusModal();
      }
      if (e.key === 'Escape' && nexusProfileModal.style.display !== 'none') {
        closeNexusProfile();
      }
    });

    // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø—Ä–æ—Ñ–∏–ª—è –º–æ–¥–∞–ª–∞
    document.getElementById('nexus-profile-modal-close').addEventListener('click', closeNexusProfile);

    async function loadMe() {
      const res = await fetch('/me');
      const data = await res.json();
      if (!data.loggedIn) {
        window.location.href = '/login.html';
        return;
      }
      currentUser = data;
      currentUsernameEl.textContent = data.displayName || data.username;
      if (data.isAdmin) {
        adminPanelBtn.style.display = 'block';
      }
      document.getElementById('profile-link').onclick = () => {
        window.location.href = '/profile.html';
      };
    }

    function createAvatarNode(avatarUrl, title) {
      const avatar = document.createElement('div');
      avatar.className = 'nexus-avatar';
      if (avatarUrl) {
        avatar.style.backgroundImage = `url(${avatarUrl})`;
      } else {
        avatar.textContent = (title || 'N').trim().charAt(0).toUpperCase();
      }
      return avatar;
    }

    function renderNexusCard(item) {
      const card = document.createElement('div');
      card.className = 'nexus-card';
      
      // –î–æ–±–∞–≤–ª—è–µ–º –∫–ª–∞—Å—Å –¥–ª—è –æ—Ç–ª–∏—á–∏—è –Ω–µ–∫—Å—Ñ–µ—Ä –æ—Ç –Ω–µ–∫—Å—É—Å–æ–≤
      if (item.type === 'nexfery') {
        card.classList.add('nexus-card-nexfery');
      }

      const header = document.createElement('div');
      header.className = 'nexus-card-header';

      const avatar = createAvatarNode(item.avatar_data, item.title);

      const info = document.createElement('div');
      info.className = 'nexus-info';

      const title = document.createElement('div');
      title.className = 'nexus-title';
      title.textContent = item.title;
      title.style.cursor = 'pointer';
      title.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        // –î–ª—è –Ω–µ–∫—Å—Ñ–µ—Ä –æ—Ç–∫—Ä—ã–≤–∞–µ–º –Ω–µ–∫—Å—Ñ–µ—Ä—ã.html, –¥–ª—è –Ω–µ–∫—Å—É—Å–æ–≤ –æ—Ç–∫—Ä—ã–≤–∞–µ–º –ø—Ä–æ—Ñ–∏–ª—å
        if (item.type === 'nexfery') {
          window.location.href = `/nexferies.html?id=${item.id}`;
        } else {
          openNexusProfile(item.id);
        }
      });

      const handle = document.createElement('div');
      handle.className = 'nexus-handle';
      handle.textContent = `@${item.handle}`;

      const meta = document.createElement('div');
      meta.className = 'nexus-meta';
      const authorName = item.author_display_name || item.author_username;
      const label = item.type === 'nexfery' ? '–£—á–∞—Å—Ç–Ω–∏–∫–∏' : '–ü–æ–¥–ø–∏—Å—á–∏–∫–∏';
      const postLabel = item.type === 'nexfery' ? '–°–æ–æ–±—â–µ–Ω–∏—è' : '–ü–æ—Å—Ç—ã';
      meta.textContent = `–ê–≤—Ç–æ—Ä: ${authorName} ¬∑ ${label}: ${item.subscribers_count} ¬∑ ${postLabel}: ${item.posts_count}`;

      info.appendChild(title);
      info.appendChild(handle);
      info.appendChild(meta);

      header.appendChild(avatar);
      header.appendChild(info);

      const desc = document.createElement('div');
      desc.className = 'nexus-desc';
      desc.textContent = item.description || '–ë–µ–∑ –æ–ø–∏—Å–∞–Ω–∏—è';

      const actions = document.createElement('div');
      actions.className = 'nexus-actions';

      const openBtn = document.createElement('button');
      openBtn.className = 'btn-secondary';
      openBtn.textContent = '–û—Ç–∫—Ä—ã—Ç—å';
      openBtn.onclick = (e) => {
        e.preventDefault();
        if (item.type === 'nexfery') {
          // –î–ª—è –Ω–µ–∫—Å—Ñ–µ—Ä –æ—Ç–∫—Ä—ã–≤–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É –Ω–µ–∫—Å—Ñ–µ—Ä
          window.location.href = `/nexferies.html?id=${item.id}`;
        } else {
          // –î–ª—è –Ω–µ–∫—Å—É—Å–æ–≤ –æ—Ç–∫—Ä—ã–≤–∞–µ–º –ø—Ä–æ—Ñ–∏–ª—å
          if (window.innerWidth <= 768) {
            // –ù–∞ –º–æ–±–∏–ª—è—Ö –æ—Ç–∫—Ä—ã–≤–∞–µ–º –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ
            openNexusModal(item.id);
          } else {
            // –ù–∞ –¥–µ—Å–∫—Ç–æ–ø–µ –æ—Ç–∫—Ä—ã–≤–∞–µ–º –Ω–∞ –Ω–æ–≤–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ
            window.location.href = `/nexus/profile?id=${item.id}`;
          }
        }
      };

      actions.appendChild(openBtn);

      const role = item.my_role;
      if (item.type === 'nexfery') {
        // –î–ª—è –Ω–µ–∫—Å—Ñ–µ—Ä –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å "–£—á–∞—Å—Ç–Ω–∏–∫"
        const memberBadge = document.createElement('span');
        memberBadge.className = 'nexus-badge';
        memberBadge.textContent = '–£—á–∞—Å—Ç–Ω–∏–∫';
        actions.appendChild(memberBadge);
      } else if (role === 'owner') {
        const ownerBadge = document.createElement('span');
        ownerBadge.className = 'nexus-badge';
        ownerBadge.textContent = '–í–ª–∞–¥–µ–ª–µ—Ü';
        actions.appendChild(ownerBadge);
      } else {
        const subBtn = document.createElement('button');
        subBtn.className = role ? 'btn-ghost' : 'btn-primary';
        subBtn.textContent = role ? '–û—Ç–ø–∏—Å–∞—Ç—å—Å—è' : '–ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è';
        subBtn.onclick = async () => {
          subBtn.disabled = true;
          try {
            if (role) {
              await fetch(`/api/nexus/${item.id}/unsubscribe`, { method: 'POST' });
            } else {
              await fetch(`/api/nexus/${item.id}/subscribe`, { method: 'POST' });
            }
            await loadNexus();
          } catch (err) {
            console.error(err);
          } finally {
            subBtn.disabled = false;
          }
        };
        actions.appendChild(subBtn);
      }

      card.appendChild(header);
      card.appendChild(desc);
      card.appendChild(actions);

      return card;
    }

    async function loadNexus() {
      nexusListEl.innerHTML = '<div class="nexus-loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';
      const res = await fetch('/api/nexus');
      const data = await res.json();
      if (!data.ok) {
        nexusListEl.innerHTML = '<div class="nexus-error">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –Ω–µ–∫—Å—É—Å—ã</div>';
        return;
      }

      nexusListEl.innerHTML = '';
      if (data.nexus.length === 0) {
        const empty = document.createElement('div');
        empty.className = 'nexus-empty';
        empty.textContent = '–ü–æ–∫–∞ –Ω–µ—Ç –Ω–µ–∫—Å—É—Å–æ–≤. –°–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤—ã–π!';
        nexusListEl.appendChild(empty);
        return;
      }

      data.nexus.forEach((item) => {
        nexusListEl.appendChild(renderNexusCard(item));
      });
    }

    createForm.addEventListener('submit', async (event) => {
      event.preventDefault();
      console.log('Form submitted');
      nexusErrorEl.textContent = '';

      try {
        const formData = new FormData(createForm);
        const res = await fetch('/api/nexus', {
          method: 'POST',
          body: formData
        });
        const data = await res.json();
        console.log('Response:', data);
        if (!data.ok) {
          nexusErrorEl.textContent = data.error || '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –Ω–µ–∫—Å—É—Å';
          return;
        }

        createForm.reset();
        document.getElementById('nexus-file-name').textContent = '';
        document.querySelector('.nexus-form-card').style.display = 'none';
        document.getElementById('create-nexus-buttons').style.display = 'flex';
        await loadNexus();
      } catch (err) {
        console.error('Error:', err);
        nexusErrorEl.textContent = '–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –Ω–µ–∫—Å—É—Å–∞';
      }
    });

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ –æ—Ç–º–µ–Ω—ã
    document.getElementById('nexus-cancel-btn').addEventListener('click', () => {
      createForm.reset();
      const fileNameEl = document.getElementById('nexus-file-name');
      fileNameEl.textContent = '';
      fileNameEl.classList.remove('nexus-file-selected');
      nexusErrorEl.textContent = '';
      document.querySelector('.nexus-form-card').style.display = 'none';
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –Ω–µ–∫—Å—É—Å–∞
      if (document.getElementById('create-nexus-buttons')) {
        document.getElementById('create-nexus-buttons').style.display = 'flex';
      }
    });

    // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏–º–µ–Ω–∏ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞
    document.getElementById('nexus-avatar').addEventListener('change', (e) => {
      const fileName = e.target.files[0]?.name || '';
      const fileNameEl = document.getElementById('nexus-file-name');
      if (fileName) {
        fileNameEl.textContent = `‚úì –í—ã–±—Ä–∞–Ω: ${fileName}`;
        fileNameEl.classList.add('nexus-file-selected');
      } else {
        fileNameEl.textContent = '';
        fileNameEl.classList.remove('nexus-file-selected');
      }
    });

    // –ü–æ–∫–∞–∑–∞—Ç—å —Ñ–æ—Ä–º—É —Å–æ–∑–¥–∞–Ω–∏—è –Ω–µ–∫—Å—É—Å–∞ –ø—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ –∫–Ω–æ–ø–∫—É
    document.getElementById('show-nexus-form-btn').addEventListener('click', () => {
      document.querySelector('.nexus-form-card').style.display = 'block';
      document.getElementById('create-nexus-buttons').style.display = 'none';
      document.querySelector('.nexus-form-card').scrollIntoView({ behavior: 'smooth' });
    });

    (async () => {
      await loadMe();
      await loadNexus();
    })();
  </script>
</body>
</html>
